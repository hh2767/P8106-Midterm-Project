---
title: "Nonlinear"
author: "JunLu"
date: "4/1/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE
                      )
library(caret)
theme1 <- trellis.par.get()
theme1$plot.symbol$col <- rgb(.2, .4, .2, .2) 
theme1$plot.symbol$pch <- 16
theme1$plot.line$col <- rgb(.8, .1, .1, 1) 
theme1$plot.line$lwd <- 2
theme1$strip.background$col <- rgb(.0, .2, .6, .2)
trellis.par.set(theme1)

library(tidyverse)
library(caret)
library(splines)
library(gam)
library(mgcv)
library(boot)
library(pdp)
library(earth)
```


## Import the train dataset

```{r}
train = read_csv("./train.csv") %>% 
    select(-na_count)
y = train$transformed_value
x = model.matrix(transformed_value ~ ., train)[,-1] 
```

## Set a random seed

```{r}
set.seed(1)
```


## Generallized additive model (GAM)

### Use caret package
```{r}
ctrl1 <- trainControl(method = "cv", number = 5)
gam.fit = train(x, y,
                 method = "gam",
                 tuneGrid = data.frame(method = "GCV.Cp", 
                                       select = c(TRUE,FALSE)), 
                 trControl = ctrl1)

save(gam.fit, file = "./gam_fit.rda")

# load(file = "./gam_fit.rda")

gam.fit$bestTune
gam.fit$finalModel
```
```{r}
gam = gam(transformed_value ~ age + nationality + club + potential + special + acceleration 
             + aggression + agility + balance + ball_control + composure + crossing + curve + 
                 dribbling + finishing + free_kick_accuracy + gk_diving + gk_handling + gk_kicking +
                 gk_positioning + gk_reflexes + heading_accuracy + interceptions +
                 jumping + long_passing + long_shots + marking + penalties + positioning +
                 reactions + short_passing + shot_power + sliding_tackle + sprint_speed + stamina +
                 standing_tackle + strength + vision + volleys, data = train)
```



### Set the model by exploratory analysis
```{r}
gam.m1 = gam(transformed_value ~ age + nationality + club + potential + special + acceleration 
             + aggression + agility + balance + ball_control + composure + crossing + curve + 
                 dribbling + finishing + free_kick_accuracy + gk_diving + gk_handling + gk_kicking +
                 gk_positioning + gk_reflexes + heading_accuracy + interceptions +
                 jumping + long_passing + long_shots + marking + penalties + positioning +
                 reactions + short_passing + shot_power + sliding_tackle + sprint_speed + stamina +
                 standing_tackle + strength + vision + volleys, data = train)

gam.m2 = gam(transformed_value ~ s(age) + nationality + club + potential + special + acceleration 
             + aggression + agility + balance + ball_control + composure + crossing + curve + 
                 dribbling + finishing + free_kick_accuracy + gk_diving + gk_handling + gk_kicking +
                 gk_positioning + gk_reflexes + heading_accuracy + interceptions +
                 jumping + long_passing + long_shots + marking + penalties + positioning +
                 reactions + short_passing + shot_power + sliding_tackle + sprint_speed + stamina +
                 standing_tackle + strength + vision + volleys, data = train)

gam.m3 = gam(transformed_value ~ s(age) + nationality + club + potential + special + acceleration 
             + aggression + agility + balance + ball_control + composure + crossing + curve + 
                 dribbling + finishing + free_kick_accuracy + gk_diving + gk_handling + gk_kicking +
                 gk_positioning + gk_reflexes + heading_accuracy + interceptions +
                 jumping + long_passing + long_shots + marking + penalties + positioning +
                 s(reactions) + short_passing + shot_power + sliding_tackle + sprint_speed + 
                 stamina + standing_tackle + strength + vision + volleys, data = train)

gam.m4 = gam(transformed_value ~ s(age) + nationality + club + s(potential) + s(special) + acceleration 
             + aggression + agility + balance + ball_control + composure + crossing + curve + 
                 dribbling + finishing + free_kick_accuracy + gk_diving + gk_handling + gk_kicking +
                 gk_positioning + gk_reflexes + heading_accuracy + interceptions +
                 jumping + long_passing + long_shots + marking + penalties + positioning +
                 s(reactions) + short_passing + shot_power + sliding_tackle + sprint_speed + 
                 stamina + standing_tackle + strength + vision + volleys, data = train)

anova(gam.m1, gam.m2, gam.m3, gam.m4, test = "F")
```

## Multivariate Adaptive Regression Splines (MARS)

```{r}
ctrl1 <- trainControl(method = "cv", number = 5)
mars_grid = expand.grid(degree = 1:2,
                        nprune = 2:39)
mars.fit = train(x, y,
                 method = "earth",
                 tuneGrid = mars_grid,
                 trControl = ctrl1
                 )
save(gam.fit, file = "./mars.rda")

```

