---
title: "EDA_document"
author: "Haoran Hu"
date: "2019-3-29"
output: pdf_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE
                      )
library(caret)
theme1 <- trellis.par.get()
theme1$plot.symbol$col <- rgb(.2, .4, .2, .2) 
theme1$plot.symbol$pch <- 16
theme1$plot.line$col <- rgb(.8, .1, .1, 1) 
theme1$plot.line$lwd <- 2
theme1$strip.background$col <- rgb(.0, .2, .6, .2)
trellis.par.set(theme1)

library(tidyverse)
library(patchwork)
```


#Question

How to choose the best model for predicting soccer players' wage using FIFA video game data?

#Data source

The anticipated data source of our project is a soccer player information database from the latest version of FIFA video game. The dataset contains information of 18200 soccer players. It includes 82 attributes of the players, such as market value, wages, age, and score of each specific skill.  Although the data source is a video game database, it accurately reflects current soccer players’ personal information, skills, values, etc. Therefore, it is sensible to use it to model real world situation, and to analyze the association between players’ values and various characteristics of the players. After data cleaning, there are 68 predictors for players' values.

#Data cleaning

(I made some changes to many variables, details are described in "Exploratory_analysis.Rmd/pdf").

```{r}
fifa = read_csv("..\\Data\\CompleteDataset.csv")

```



```{r}
set.seed(3)
```



```{r}
calc_expression = function(fmula) {
    eval(parse(text = fmula))
}

data = fifa %>% 
    janitor::clean_names() %>% 
    select(-c(x1, name, photo, flag, club_logo, wage, overall, id)) %>% 
    mutate(value = str_replace(value, "K", "/ 1000"),
           value = str_replace(value, "M", ""),
           value = str_replace(value, "€", "")) %>% 
    mutate(value = map(value, calc_expression),
           value = as.numeric(value)) %>% 
    mutate(value = readr::parse_number(value))
    
```


```{r}
data = data %>% 
    filter(preferred_positions == "GK") %>% 
    select(-(cam:st))

```



```{r}
trans2int_cols = c(7:40)
trans2fct_cols = c(2, 4)
data[trans2int_cols] = map(data[trans2int_cols], as.integer)
data[trans2fct_cols] = map(data[trans2fct_cols], as.factor)
```

##Checking and replacing NA's

First, I checked missing data for each observation. Since a lot of NA's are caused by missing position score data of goal keepers, and These NA's do not matter, I will amalyze goal-keeper data and non goal-keeper data seperately.

```{r}

data = data %>% 
    mutate(., na_count = apply(., 1, function(x) sum(is.na(x))))#the na_count shows number of NA's that are not caused by missing position score data in each observation 

data %>% 
    filter(na_count > 0) %>% 
    ggplot(aes(x = na_count)) + geom_histogram(fill = "navy") + theme_bw() + labs(title = "Distribution of NA's in goal-keeper data") + theme(plot.title = element_text(size = 10))

```


From the plot, it seems to be reasonable to drop observations that have more than 5 missing values. 

Next, I:

* dropped observations that have more than 5 missing values

* checked number of NA's in each variable

```{r fig.height=13, fig.width=11}
data = data %>% 
    filter(na_count <= 5)

library(VIM)
matrixplot(data)

```

In the plot above, red color represents missing data.

```{r}
na_col = colSums(is.na(data)) %>% 
    as.list() %>% 
    as.data.frame() %>% 
    select(-na_count) %>% 
    gather(age:volleys, key = "variable", value = "num_of_na")

na_col %>% 
    filter(num_of_na > 0) %>% 
    mutate(variable = fct_reorder(variable, num_of_na)) %>% 
    ggplot(aes(x = variable, y = num_of_na)) + 
  geom_col(fill = "navy") +  
  theme(legend.position = "bottom") + 
  labs(title = "number of missing values for variables that have NA(s)", y = "number of missing values") +
  coord_flip() + theme(axis.text.x = element_text(face = "plain", color = "black", size = 8)) + theme_bw()
```

In total, 14 variables have missing values. The "club" variable has the largest number of missing values(42 missing values). Note that all the players that have missing "club" values have market values = 0. This actually means they do not belong to any club for the time being. Each of the other variables that have missing values has less than 25 missing values. Compared to the sample size, that's not a big loss of data, and thus all the variables can be kept in the model. 

Therefore, I

* replaced NA's in "club" column with a new category "none"

* replaced NA's in each column except "club" column by the mean of that column. This will be done seperately for goal keepers and for non goal keepers.

```{r}
#library(mice)


data = data %>% 
    mutate(club = forcats::fct_explicit_na(club, na_level = "none"))
#get the names of variables that have missing values, except for "club"
vbls_replace_NA = na_col %>% 
    filter(num_of_na > 0 & variable != "club")

#data = complete(mice(data = data, method = "mean", m = 1)) #Too slow

#for variables(except for "club") that have missing values, replace NA's with mean
for (i in 1:13) {
    vbl_name = vbls_replace_NA$variable[i]
    #col_num = which(colnames(data) == vbl_name) %>% 
        #as.numeric()
       vec = data[vbl_name] %>% 
        unlist() %>% 
        unname()
       #data[is.na(data[,col_num]), col_num] = round(mean(vec, na.rm = TRUE))
       data[is.na(data[,vbl_name]), vbl_name] = round(mean(vec, na.rm = TRUE))
       
}

#sapply(data, function(x) sum(is.na(x))) #no NA's in any column
```

#Tables for descriptive statistics

```{r}
descrip_list = data %>% 
    skimr::skim_to_list()

descrip_list[[1]] %>% 
    select(variable, n_unique) %>% 
    dplyr::rename("unique levels" = n_unique) %>% 
    knitr::kable(caption = "Factor variables")
    
 
bind_rows(descrip_list[[2]] , descrip_list[[3]]) %>% 
    dplyr::select(variable, 
                Min = p0,
                `1st Q` = p25,
                Mean = mean,
                Median = p50,
                `3rd Q` = p75,
                Max = p100,
                `Std Dev` = sd) %>% 
  knitr::kable(digits = 3, caption = "Integer/numeric variables")

```

#Figures for descriptive statistics

##For the outcome(value)

```{r}
data %>% 
    ggplot(aes(x = value)) + geom_density(fill = "navy") + theme_bw()
```

The outcome data is skewed, so I transformed it. New_value = Old_value^(1/4)

```{r}
#The effect of log transformation is not ideal
#data = data %>%
#   mutate(value = log(value + 2)

data = data %>% 
    mutate(value = value^(1/4)) %>% 
    rename("transformed_value" = value)

data %>% 
    ggplot(aes(x = transformed_value)) + geom_density(fill = "navy") + theme_bw()
```

After tramsformation, the distribution of the outcome is less skewed. There are a lot of 0 values becaues there are many players that do not belong to any club.

##Check the distribution for each numeric/integer predictor

```{r fig.height=13, fig.width=11}
#library(gridExtra)

p1 = data[,1:19] %>%
    select(-transformed_value) %>% 
  keep(is.numeric) %>%                     # Keep only numeric columns
  gather() %>%                             # Convert to key-value pairs
  ggplot(aes(value)) +                     # Plot the values
    facet_wrap(~ key, scales = "free") +   # In separate panels
    geom_density() +
    theme_bw() 
    

p2 = data[,20:35] %>%
  keep(is.numeric) %>%                     # Keep only numeric columns
  gather() %>%                             # Convert to key-value pairs
  ggplot(aes(value)) +                     # Plot the values
    facet_wrap(~ key, scales = "free") +   # In separate panels
    geom_density() +
    theme_bw()

p1/p2
```

\newpage

```{r}
data[,36:40] %>%
  keep(is.numeric) %>%                     # Keep only numeric columns
  gather() %>%                             # Convert to key-value pairs
  ggplot(aes(value)) +                     # Plot the values
    facet_wrap(~ key, scales = "free") +   # In separate panels
    geom_density()  +
    theme_bw()
```

There seems not to be any data error. The variable `max_pos_score` has unusually large amount of 0 zero values because I set it to be 0 for goal keepers. For the variables whose density plots have two peaks, the smaller peaks are generally caused by goal keepers, and the larger peaks are generally caused by non-goal keepers.

##plot for variables

###for factor variables


* nationality

plot the situation for nations with the most number of players:

```{r}
nation_box = data %>% 
    mutate(nationality = fct_lump(nationality, 12)) %>% 
    mutate(nationality = fct_infreq(nationality)) %>% 
    mutate(nationality = fct_rev(nationality)) %>% 
    #move "Other" level to the last:
    mutate(nationality = fct_relevel(nationality, "Other", after = 0)) %>% 
    ggplot(aes(x = nationality, y = transformed_value)) +
geom_boxplot() +
theme(legend.position = "bottom") +
labs( x = NULL) +
coord_flip() + theme(axis.text.x = element_text(face = "plain", color = "black", size = 8)) + theme_bw()

nation_hist = data %>% 
    #If focus on most common nations:
    mutate(nationality = fct_lump(nationality, 12)) %>% #nations that have fewer players will be denoted as "Other"
    mutate(nationality = fct_infreq(nationality)) %>% 
    mutate(nationality = fct_rev(nationality)) %>% 
    #move "Other" level to the last:
    mutate(nationality = fct_relevel(nationality, "Other", after = 0)) %>% 
    ggplot(aes(x = nationality)) +
    geom_bar(fill = "navy") +
    theme(legend.position = "bottom") +
    labs(title = "Player count/transformed_value by nationality", subtitle = "Nations with most players. This plot suggests that players' \n transformed_values vary between different nations") +
    coord_flip() + theme(axis.text.x = element_text(face = "plain", color = "black", size = 8))  + 
    theme_bw()

nation_hist + nation_box
```

plot the nations with highest players' transformed_values:

```{r}
nation_box = data %>%
    group_by(nationality) %>% 
    mutate(med_by_nation = median(transformed_value)) %>% 
    ungroup() %>% 
    mutate(nationality = fct_reorder(nationality, med_by_nation)) %>% 
    filter(as.integer(nationality) >= 77) %>%  #get the nations that have the largest median player transformed_values
    ggplot(aes(x = nationality, y = transformed_value)) +
    geom_boxplot() +
    theme(legend.position = "bottom") +
    labs( x = NULL) +
    coord_flip() + theme(axis.text.x = element_text(face = "plain", color = "black", size = 8)) + theme_bw()

nation_hist = data %>%
    group_by(nationality) %>% 
    mutate(med_by_nation = median(transformed_value)) %>% 
    ungroup() %>% 
    mutate(nationality = fct_reorder(nationality, med_by_nation)) %>% 
    filter(as.integer(nationality) >= 77) %>%  #get the nations that have the largest median player transformed_values
    ggplot(aes(x = nationality)) +
    geom_bar(fill = "navy") +
    theme(legend.position = "bottom") +
    labs(title = "Player count/transformed_value by nation", subtitle = "Nations with highest median player transformed_values. Those with the highest player\n transformed_values typically have very little player data recorded.") +
    coord_flip() + theme(axis.text.x = element_text(face = "plain", color = "black", size = 8))  + theme_bw()

nation_hist + nation_box
```


* club

clubs that have the largest number of players

```{r}
club_box = data %>% 
    mutate(club = fct_lump(club, 12)) %>% 
    mutate(club = fct_infreq(club)) %>% 
    mutate(club = fct_rev(club)) %>% 
    #move "Other" level to the last:
    filter(club != "Other") %>% 
    ggplot(aes(x = club, y = transformed_value)) +
geom_boxplot() +
theme(legend.position = "bottom") +
labs( x = NULL) +
coord_flip() + theme(axis.text.x = element_text(face = "plain", color = "black", size = 8)) + theme_bw()

club_hist = data %>% 
    mutate(club = fct_lump(club, 12)) %>% 
    mutate(club = fct_infreq(club)) %>% 
    mutate(club = fct_rev(club)) %>% 
    #move "Other" level to the last:
    filter(club != "Other") %>% 
    ggplot(aes(x = club)) +
    geom_bar(fill = "navy") +
    theme(legend.position = "bottom") +
    labs(title = "Player count/transformed_value by club", subtitle = "Clubs with most players. Since numbers of players in different\nclubs do not vary greatly, this plot is not very useful.") +
    coord_flip() + theme(axis.text.x = element_text(face = "plain", color = "black", size = 8))  + 
    theme_bw()

club_hist + club_box
```

clubs that have the highest player median transformed_values

```{r}
club_box = data %>%
    group_by(club) %>% 
    mutate(med_by_club = median(transformed_value)) %>% 
    ungroup() %>% 
    mutate(club = fct_reorder(club, med_by_club)) %>% 
    filter(as.integer(club) >= 630) %>%  #get the clubs that have the highest median transformed_values
    ggplot(aes(x = club, y = transformed_value)) +
    geom_boxplot() +
    theme(legend.position = "bottom") +
    labs( x = NULL) +
    coord_flip() + theme(axis.text.x = element_text(face = "plain", color = "black", size = 8))  + theme_bw()

club_hist = data %>%
    group_by(club) %>% 
    mutate(med_by_club = median(transformed_value)) %>% 
    ungroup() %>% 
    mutate(club = fct_reorder(club, med_by_club)) %>% 
    filter(as.integer(club) >= 630) %>%  #get the clubs that have the highest median transformed_values
    ggplot(aes(x = club)) +
    geom_bar(fill = "navy") +
    theme(legend.position = "bottom") +
    labs(title = "Player count/transformed_value by club", subtitle = "Clubs with highest median player transformed_values. This plot suggests that players' \n transformed_values vary between different clubs") +
    coord_flip() + theme(axis.text.x = element_text(face = "plain", color = "black", size = 8))  + theme_bw()

club_hist + club_box
```

###for int/num variables


```{r fig.height=15, fig.width=11}
# matrix of predictors

data_num  = data %>% 
    keep(is.numeric) %>% 
    select_if(~ !any(is.na(.))) %>% 
    select(-transformed_value)

#for factor variables
data_fct  = data %>%  
    select(-transformed_value) %>% 
    select_if(~ is.factor(.))


# vector of response
y <- data$transformed_value


featurePlot(data_num,
y,
plot = "scatter",
span = .5,
labels = c("Predictors","Y"),
type = c("p", "smooth"),
layout = c(4, 10))


```

\newpage

These plots shows that the outcome tend to increase with the increase in levels of most of the numerical predictors, except for `age`. The relationships between the outcome and the predictors are possibly non-linear.






###FeaturePlots for factor variables

```{r}
featurePlot(data$transformed_value, data_fct$nationality, "box", labels = c("Nationality","Y"))
featurePlot(data$transformed_value, data_fct$club, "box", labels = c("Club","Y"))
```

These plots shows that players' valus tend to vary between different nationalities, clubs and positions. In addition, players that have multiple preferred positions tend to have slightly greater values compared to those who only have one preferred position.

##Correlation plot

The plot would be too large to display if we put in all the variables, so I just selected a subset of variables to display. 

```{r fig.height=12, fig.width=12}
library(corrplot)

cor_data = data %>% 
    select(-club, -nationality)
x <- model.matrix(transformed_value~.,cor_data)[,-1]

corrplot(cor(x), tl.cex = 1.2)
```

This plot shows that scores that are specificly measured for goal keepers(i.e. variable whose names start with "gk_") are highly correlated.

#Split the data set into training and testing data

```{r}
trRows = createDataPartition(data$transformed_value, p = .75, list = FALSE)
train = data[trRows,] %>% write_csv("..\\exploratory analysis\\train.csv")
test = data[-trRows,] %>% write_csv("..\\exploratory analysis\\test.csv")
```

Training and testing datasets can be found in the exploratory analysis folder. There are also copies of the training and testing datasets in the "Data" folder.


